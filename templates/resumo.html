{% extends "layout.html" %}

{% block title %}Etapa 3: Resumo e Edição Final{% endblock %}

{% block head_styles %}
<style>
    h1 { text-align: center; color: var(--text-color); font-weight: 700; margin-bottom: 2rem; }
    h1 span { color: var(--primary-color); }
    h2 { margin-top: 2rem; color: var(--primary-color); opacity: 0.9; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1.5rem; font-size: 1.5rem; }
    .summary-section { background-color: var(--surface-color); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; }
    .summary-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 768px) { .summary-grid { grid-template-columns: 1fr 1fr; } }
    .summary-item strong { color: var(--primary-color); display: block; margin-bottom: 0.25rem;}
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.5rem; }
    label { font-weight: 500; color: #aeb9c5; }
    textarea { background-color: var(--surface-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; font-size: 1rem; width: 100%; box-sizing: border-box; resize: vertical; min-height: 120px; }
    .main-button { width: 100%; margin-top: 1rem; padding: 15px; background-color: var(--success-color); color: white; border: none; border-radius: 8px; font-size: 1.2rem; font-weight: 700; cursor: pointer; }
    .main-button:disabled { background-color: #555; cursor: not-allowed; }
    .button-group { display: flex; gap: 1rem; margin-top: 2rem; }
    .back-button { background-color: var(--border-color); color: var(--text-color); flex-grow: 0.5; }
    .next-button { flex-grow: 2; }
    .result-wrapper { margin-top: 2rem; background-color: #101820; border-radius: 8px; padding: 1.5rem; position: relative; display: none; }
    #final-prompt-output { white-space: pre-wrap; line-height: 1.7; }
    .copy-button { position: absolute; top: 1rem; right: 1rem; background-color: var(--primary-color); color: var(--button-text-dark); border: none; border-radius: 5px; padding: 8px 12px; cursor: pointer; font-weight: 500; }
</style>
{% endblock %}

{% block content %}
    <h1>Resumo e <span>Edição Final</span></h1>
    <p style="text-align: center; margin-top: -1.5rem; color: #aeb9c5;">Etapa 3 de 3: Revise, edite e monte o prompt final.</p>

    <div class="summary-section">
        <h2>Ajustes Finais Selecionados</h2>
        <div class="summary-grid">
            <div class="summary-item"><strong>Contexto da Ação:</strong> {{ session.get('details', {}).get('action_context', 'N/A') }}</div>
            <div class="summary-item"><strong>Idioma:</strong> {{ session.get('details', {}).get('language', 'N/A') }}</div>
            <div class="summary-item"><strong>Sotaque:</strong> {{ session.get('details', {}).get('accent', 'N/A') }}</div>
            <div class="summary-item"><strong>Estilo Visual:</strong> {{ session.get('details', {}).get('visual_style', 'N/A') }}</div>
            <div class="summary-item"><strong>Câmera:</strong> {{ session.get('details', {}).get('camera_style', 'N/A') }}</div>
        </div>
    </div>

    <div id="editor-sections">
        <div class="form-group">
            <label for="scenario-edit">Ficha Técnica do Cenário</label>
            <textarea id="scenario-edit">{{ session.get('scenario', {}).get('description', '') }}</textarea>
        </div>
        {% for char in session.get('characters', []) %}
        <div class="form-group">
            <label for="char-edit-{{ char.id }}">Ficha Técnica do {{ char.name }}</label>
            <textarea id="char-edit-{{ char.id }}">{{ char.description }}</textarea>
        </div>
        {% endfor %}
    </div>
    
    <div class="button-group">
        <a href="{{ url_for('detalhes') }}" class="main-button back-button" style="text-align: center; text-decoration: none;">&larr; Voltar para Detalhes</a>
        <button id="assemble-btn" class="main-button" onclick="assemblePrompt()">Montar Prompt Final</button>
    </div>

    <div class="result-wrapper" id="result-wrapper">
        <h2>Prompt Final Montado</h2>
        <button class="copy-button" onclick="copyPrompt()">Copiar</button>
        <pre id="final-prompt-output"></pre>
    </div>
{% endblock %}

{% block scripts %}
<script>
    async function assemblePrompt() {
        const assembleBtn = document.getElementById('assemble-btn');
        assembleBtn.disabled = true;
        assembleBtn.innerText = 'Montando...';

        const editedScenarioDesc = document.getElementById('scenario-edit').value;
        const editedCharacters = [];
        const originalCharacters = {{ session.get('characters', [])|tojson }};
        originalCharacters.forEach(char => {
            editedCharacters.push({
                id: char.id,
                name: char.name,
                description: document.getElementById(`char-edit-${char.id}`).value
            });
        });

        const payload = {
            characters: editedCharacters,
            scenario: { description: editedScenarioDesc },
            details: {{ session.get('details', {})|tojson }}
        };

        try {
            const response = await fetch("{{ url_for('montar_prompt') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error('Falha na montagem do prompt.');
            const data = await response.json();
            
            // <<< CORREÇÃO DA CHAVE DO JAVASCRIPT >>>
            document.getElementById('final-prompt-output').innerText = data.prompt;
            document.getElementById('result-wrapper').style.display = 'block';

        } catch (error) {
            alert(`Erro: ${error.message}`);
        } finally {
            assembleBtn.disabled = false;
            assembleBtn.innerText = 'Montar Prompt Final';
        }
    }

    function copyPrompt() {
        const textToCopy = document.getElementById('final-prompt-output').innerText;
        navigator.clipboard.writeText(textToCopy).then(() => {
            alert('Prompt copiado com sucesso!');
        }, () => {
            alert('Falha ao copiar.');
        });
    }
</script>
{% endblock %}